---
- name: Test STIG Implementation
  hosts: rhel6-test
  sudo: yes
  gather_facts: no

  vars:
     profile: "MAC-1_Public"
     cpe: "U_RedHat_6_V1R6_STIG_SCAP_1-1_Benchmark-cpe-dictionary.xml"
     scap_url: "http://iase.disa.mil/stigs/Documents/U_RedHat_6_V1R6_STIG_SCAP_1-1_Benchmark.zip"
     scap_prefix: "U_RedHat_6_V1R6_STIG_SCAP_1-1_Benchmark"

  tasks:
     - name: Install OpenSCAP and Pip
       yum: pkg={{ item }} state=latest
       with_items:
         - openscap-utils
         - python-pip

     - name: Install Python Libraries
       pip: requirements=./tests/requirements.txt

     - name: Download RHEL6 STIG files for OSCAP
       get_url: url={{ scap_url }} dest=/tmp/

     - name: Unzip file
       command: unzip -o {{ scap_url | basename }}
       args:
         chdir: /tmp/

     - name: Run OpenScap Checks
       shell: oscap xccdf eval --profile {{ profile }} --results results.xml --cpe {{ scap_prefix }}-cpe-dictionary.xml {{ scap_prefix }}-xccdf.xml > /dev/null 2>&1
       args:
         chdir: /tmp/
       register: results
       ignore_errors: yes

     - name: Run Stigma
       script: ./stigma -P ./results.xml -H 90 -M 50 -L 24 -T 44
       args:
         chdir: /tmp/ 
