---
- name: V-38612 Medium  The SSH daemon must not allow host-based authentication
  lineinfile: state=present dest=/etc/ssh/sshd_config regexp='^(#)?HostbasedAuthentication' line='HostbasedAuthentication no'
  tags: [ 'ssh' , 'cat2', 'V-38612' , 'ssh' ]
  notify: restart ssh


# This audit.rules file is from https://github.com/RedHatGov/stig-fix-el6/tree/master/config
# I modified it slightly by turning it into a template
- name: V-38580 V-38680 Medium  Copy STIG compliant audit.rules
  template: src=audit.rules.j2 dest=/etc/audit/audit.rules owner=root group=root mode=0640 backup=yes
  tags: [ 'cat2' , 'V-38580' , 'V-38680' , 'auditd' ]
  notify: restart auditd


- name: V-38459 Medium  The /etc/group file must be group-owned by root
  file: dest=/etc/group owner=root group=root mode=0644
  tags: [ 'cat2' , 'V-38459' , 'file_perms' ]


# Search for world writable files and print them out if any are found
- name: V-38643 Medium  There must be no world-writable files on the system
  command: find / -xdev -type f -perm -002
  register: world_writable_files
  changed_when: false
  tags: [ 'cat2' , 'V-38643', 'file_perms' ]

- name: The following files are world writable. This is a finding.
  debug: var=world_writable_files.stdout_lines
  when: world_writable_files.stdout_lines
  tags: [ 'cat2' , 'V-38643', 'file_perms' ]

- name: V-38643 Medium  There must be no world-writable files on the system
  pause: prompt="World writable files are present on the system. This is a finding. Press Enter to continue"
  when: world_writable_files.stdout_lines and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38643', 'file_perms' ]


- name: "V-38551 Medium  The operating system must connect to external networks or information systems only through managed IPv6 interfaces consisting of boundary protection devices arranged in accordance with an organizational security architecture\n
         V-38549 Medium  The system must employ a local IPv6 firewall"
  service: name=ip6tables enabled=yes state=started
  when: rhel6stig_ipv6_in_use
  ignore_errors: yes
  tags: [ 'cat2' , 'V-38551' , V-38549' 'ipv6' ]


# Look in /etc/password for hashes and print them out if any are found
- name: V-38499 Medium  The /etc/passwd file must not contain password hashes
  shell: "awk -F: '($2 != \"x\") {print}' /etc/passwd"
  changed_when: false
  register: etc_password_hash_check
  ignore_errors: yes
  tags: [ 'cat2' , 'V-38499' , 'passwords' ]

- name: The following password hashes were found in /etc/passwd. This is a finding.
  debug: var=etc_password_hash_check.stdout_lines
  when: etc_password_hash_check.stdout
  tags: [ 'cat2' , 'V-38499' , 'passwords' ]

- name: V-38499 Medium  The /etc/passwd file must not contain password hashes
  pause: prompt="The following password hashes were found in /etc/passwd. This is a finding. Press Enter to continue"
  when: etc_password_hash_check.stdout and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38499' , 'passwords' ]


- name: V-38450 V-38451 Medium  The /etc/passwd file must be owned and group owned by root
  file: path=/etc/passwd owner=root group=root mode=0644
  tags: [ 'cat2' , 'V-38450' , 'passwords' ]

- name: V-38581 Medium  The system boot loader configuration file(s) must be group-owned by root
  file: path=/boot/grub/grub.conf owner=root group=root mode=0600
  tags: [ 'cat2' , 'V-38581' , 'file_perms' ]

- name: V-38458 Medium  The /etc/group file must be owned by root
  file: path=/etc/group owner=root group=root mode=0644
  tags: [ 'cat2' , 'V-38458' , 'file_perms' ]

- name: "V-38658 Medium  The system must prohibit the reuse of passwords within twenty-four iterations\n
         V-38574 Medium  The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (system-auth)\n
         V-38573 Medium  The system must disable accounts after three consecutive unsuccessful login attempts."
  template: src=system-auth-ac.j2 dest=/etc/pam.d/system-auth-ac owner=root group=root mode=0640 backup=yes
  tags: [ 'cat2' , 'V-38658' , 'V-38574' , 'V-38573' , 'passwords' , 'accounts' ]


# List all xinetd services then look for 'on' in the output
# If any xinted service is found to be on, skip these tasks since xinetd can be on if a service is using it
- name: Checking if any xinetd services are enabled
  shell: "chkconfig --list | sed -n '/xinetd based services/,$p'"
  changed_when: false
  register: xinetd_services
  tags: [ 'cat2' , 'V-38582' , 'xinetd' , 'services' ]

- name: V-38582 Medium  The xinetd service must be disabled if no network services utilizing it are enabled
  service: name=xinetd enabled=no state=stopped
  ignore_errors: yes
  when: xinetd_services.stdout.find('\ton\n') == -1
  tags: [ 'cat2' , 'V-38582' , 'xinetd' , 'services' ]


# List nfs mounts that are missing the nodev option and ask the sys admin to correct this in /etc/fstab
# This would be a bit tricky to automatically fix in /etc/fstab.
- name: Checking for nfs mounts missing the 'nodev' option
  shell: mount | grep 'type nfs' | grep -v 'nodev'
  changed_when: false
  ignore_errors: yes
  register: nfs_mounts_missing_nodev
  tags: [ 'cat2' , 'V-38652' , 'nfs' ]

- name: V-38652 Medium  Remote file systems must be mounted with the 'nodev' option
  debug: var=nfs_mounts_missing_nodev.stdout_lines
  when: nfs_mounts_missing_nodev.stdout
  tags: [ 'cat2' , 'V-38652' , 'nfs' ]

- name: V-38652 Medium  Remote file systems must be mounted with the 'nodev' option
  pause: prompt="There are nfs mounts without the 'nodev' option set. This is a finding. Press Enter to continue"
  when: nfs_mounts_missing_nodev.stdout and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38652' , 'nfs' ]


# List nfs mounts that are missing the 'nosuid' option and ask the sys admin to correct this in /etc/fstab
# This would be a bit tricky to automatically fix in /etc/fstab.
- name: Checking for nfs mounts missing the 'nosuid' option
  shell: mount | grep 'type nfs' | grep -v 'nosuid'
  changed_when: false
  ignore_errors: yes
  register: nfs_mounts_missing_nosuid
  tags: [ 'cat2' , 'V-38652' , 'nfs' ]

- name: V-38652 Medium  Remote file systems must be mounted with the nosuid option
  debug: var=nfs_mounts_missing_nosuid.stdout_lines
  when: nfs_mounts_missing_nosuid.stdout
  tags: [ 'cat2' , 'V-38652' , 'nfs' ]

- name: V-38652 Medium  Remote file systems must be mounted with the nosuid option
  pause: prompt="There are nfs mounts without the 'nosuid' option set. This is a finding. Press Enter to continue"
  when: nfs_mounts_missing_nosuid.stdout and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38652' , 'nfs' ]


- name: V-38490 Medium  The operating system must enforce requirements for the connection of mobile devices to operating systems
  kernel_blacklist: name=usb-storage
  notify: unload usb-storage
  tags: [ 'cat2' , 'V-38490' , 'mobile_devices' , 'usb_devices' , 'kernel_modules' ]

- name: V-38443 Medium  The /etc/gshadow file must be owned by root
  file: path=/etc/gshadow owner=root group=root mode=0000
  tags: [ 'cat2' , 'V-38443' , 'file_perms' ]

- name: V-38526 Medium  The system must not accept ICMPv4 secure redirect packets on any interface
  sysctl: name=net.ipv4.conf.all.secure_redirects value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38526' , 'icmp_redirects' , 'kernel_parameters' , 'network' ]

- name: V-38524 Medium  The system must not accept ICMPv4 redirect packets on any interface
  sysctl: name=net.ipv4.conf.all.accept_redirects value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38524' , 'icmp_redirects' , 'kernel_parameters' , 'network' ]

# - name: V-38488 Medium  The operating system must conduct backups of user-level information contained in the operating system per organization defined frequency to conduct backups consistent with recovery time and recovery point objectives

- name: Checking for remote log servers
  shell: grep -Er '(^[^#]?\*\.\*\s+@{1,2})|(\*\.\*\s+omrelp)' /etc/rsyslog.conf /etc/rsyslog.d/
  changed_when: false
  ignore_errors: yes
  register: remote_logging_servers
  tags: [ 'cat2' , 'V-38520' , 'logging' ]

- name: V-38520 Medium  The operating system must back up audit records on an organization defined frequency onto a different system or media than the system being audited
  pause: prompt="No remote logging server is configured. Press Enter to continue"
  when: not remote_logging_servers.stdout and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38520' , 'auditd' , 'logging' ]

- name: V-38521 Medium  The operating system must support the requirement to centrally manage the content of audit records generated by organization defined information system components
  pause: prompt="No remote logging server is configured. Press Enter to continue"
  when: not remote_logging_servers.stdout and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38521' , 'auditd' , 'logging' ]

- name: "V-38485 Medium  The operating system, upon successful logon, must display to the user the date and time of the last logon or access via a local console or tty"
  file: path={{ item }} state=absent
  with_flattened:
    - /etc/hushlogins
    - users.stdout_lines
  tags: [ 'cat2' , 'V-38485' , 'logon_settings' ]

- name: "V-38484 Medium  The operating system, upon successful logon, must display to the user the date and time of the last logon or access via ssh"
  lineinfile: state=present dest=/etc/ssh/sshd_config regexp='^(#)?PrintLastLog' line='PrintLastLog yes'
  notify: restart ssh
  tags: [ 'cat2' , 'V-38484' , 'logon_settings' ]

# - name: V-38486 Medium  The operating system must conduct backups of system-level information contained in the information system per organization defined frequency to conduct backups that are consistent with recovery time and recovery point objectives


- name: Checking for updates
  command: yum check-update
  changed_when: false
  register: yum_update_status
  ignore_errors: yes
  tags: [ 'cat2' , 'V-38481' , 'yum' , 'updates' ]

- name: V-38481 Medium  System security patches and updates must be installed and up-to-date
  pause: prompt="All available updates not installed. This is a finding. Press Enter to continue"
  when: yum_update_status.rc != 0 and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38481' , 'yum' , 'updates' ]


- name: V-38529 Medium  The system must not accept IPv4 source-routed packets by default
  sysctl: name=net.ipv4.conf.default.accept_source_route value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38529' , 'kernel_parameters' , 'network' ]


- name: Checking group group-ownership of audit files
  shell: rpm -V audit | grep '^......G'
  changed_when: false
  ignore_errors: yes
  register: audit_group_ownership
  tags: [ 'cat2' , 'V-38665' , 'file_perms' ]

- name: V-38665 Medium  The system package management tool must verify group-ownership on all files and directories associated with the audit package
  command: rpm --setugids audit
  changed_when: false
  when: audit_group_ownership.stdout
  tags: [ 'cat2' , 'V-38665' , 'file_perms' , 'rpm' ]


- name: Checking user ownership of audit files
  shell: rpm -V audit | grep '^......U'
  changed_when: false
  ignore_errors: yes
  register: audit_user_ownership
  tags: [ 'cat2' , 'V-38664' , 'file_perms' , 'auditd' , 'rpm' ]

- name: V-38664 Medium  The system package management tool must verify ownership on all files and directories associated with the audit package
  command: rpm --setugids audit
  changed_when: false
  when: audit_user_ownership.stdout
  tags: [ 'cat2' , 'V-38664' , 'file_perms' , 'auditd' , 'rpm' ]

- name: V-38667 Medium  The system must have a host-based intrusion detection tool installed
  pause: prompt="Verify that a host-based intrusion detection tool is installed. Press Enter to continue"
  when: not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38667' , 'intrusion_detection' ]


# Look for prior versions of SNMP in use and disable them if found
- name: Checking SNMP versions in use
  shell: "grep -E 'v1|v2c|com2sec' /etc/snmp/snmpd.conf | grep -v '^#'"
  changed_when: false
  ignore_errors: yes
  register: snmp_version_check
  tags: [ 'cat2' , 'V-38660', 'snmp' ]

- name: V-38660 Medium  The snmpd service must use only SNMP protocol version 3 or newer
  replace: dest=/etc/snmp/snmpd.conf regexp='(^.*)(v1|v2c|com2sec)(.*$)' replace='#\1\2\3' backup=yes
  notify: restart snmpd
  when: snmp_version_check.stdout
  tags: [ 'cat2' , 'V-38660' , 'snmp' ]

- name: Previous versions of SNMP disabled
  pause: prompt="Versions of SNMP prior to version 3 were found and disabled. More work must be done to fully convert to SNMPv3. Press Enter to continue"
  when: snmp_version_check.stdout and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38660' , 'snmp' ]


- name: Checking permissions of audit files
  shell: rpm -V audit | grep '^.M'
  changed_when: false
  ignore_errors: yes
  register: audit_permissions
  tags: [ 'cat2' , 'V-38663' , 'file_perms' , 'auditd' , 'rpm' ]

- name: V-38663 Medium  The system package management tool must verify permissions on all files and directories associated with the audit package
  command: rpm --setperms audit
  when: audit_permissions.stdout
  tags: [ 'cat2' , 'V-38663' , 'file_perms' , 'auditd' , 'rpm' ]


- name: V-38446 Medium  The mail system must forward all mail for root to one or more system administrators
  lineinfile: "state=present backup=yes dest=/etc/aliases regexp='^root:' line='root:        {{ rhel6stig_root_email_address }}'"
  when: rhel6stig_root_email_address
  notify: update postfix aliases.db
  tags: [ 'cat2' , 'V-38446' , 'mail' ]

- name: V-38466 Medium  Library files must be owned by root
  file: dest={{ item }} owner=root recurse=yes
  with_items:
    - /lib
    - /lib64
    - /usr/lib
    - /usr/lib64
  tags: [ 'cat2' , 'V-38466' , 'file_perms' ]


- name: V-38465 Medium  Library files must have mode 0755 or less permissive
  command: "find -L {{ item }} -perm /022 -exec chmod go-w '{}' ';'"
  with_items:
    - /lib
    - /lib64
    - /usr/lib
    - /usr/lib64
  tags: [ 'cat2' , 'V-38465' , 'file_perms' ]

- name: "V-38464 Medium  The audit system must take appropriate action when there are disk errors on the audit storage volume\n
         V-38468 Medium  The audit system must take appropriate action when the audit storage volume is full\n
         V-38678 Medium  The audit system must provide a warning when allocated audit record storage volume reaches a documented percentage of maximum audit record storage capacity\n
         V-38470 Medium  The audit system must alert designated staff members when the audit storage volume approaches capacity"
  template: src=auditd.conf.j2 dest=/etc/audit/auditd.conf owner=root group=root mode=0640 backup=yes
  notify: restart auditd
  tags: [ 'cat2' , 'V-38464' , 'V-38468' , 'V-38678' , 'V-38470' , 'auditd' ]

- name: V-38461 Medium  The /etc/group file must have mode 0644 or less permissive
  file: dest=/etc/group owner=root group=root mode=0644
  tags: [ 'cat2' , 'V-38461' , 'file_perms' ]

- name: V-38469 Medium  All system command files must have mode 0755 or less permissive
  command: "find -L {{ item }} -perm /022 -exec chmod go-w '{}' ';'"
  with_items:
    - /bin
    - /usr/bin
    - /usr/local/bin
    - /sbin
    - /usr/sbin
    - /usr/local/sbin
  tags: [ 'cat2' , 'V-38469' , 'file_perms' ]

- name: V-38553  Medium  The operating system must prevent public IPv6 access into an organizations internal networks, except as appropriately mediated by managed interfaces employing boundary protection devices
  service: name=ip6tables enabled=yes state=started
  when: rhel6stig_ipv6_in_use
  tags: [ 'cat2' , 'V-38553' , 'kernel_parameters' , 'network' , 'ipv6' ]

- name: "V-38498 Medium  Audit log files must have mode 0640 or less permissive\n
        V-38445 Medium  Audit log files must be group-owned by root"
  file: dest=/var/log/audit/audit.log owner=root group=root mode=0600
  tags: [ 'cat2' , 'V-38498' , 'V-38445' , 'auditd' , 'file_perms' ]

- name: V-38555 Medium  The system must employ a local IPv4 firewall
  service: name=iptables enabled=yes state=started
  tags: [ 'cat2' , 'V-38555' , 'firewall' ]

- name: V-38492 Medium  The system must prevent the root account from logging in from virtual consoles
  lineinfile: state=absent dest=/etc/securetty regexp='^.*vc/\d' backup=yes
  tags: [ 'cat2' , 'V-38492' , 'root_access' ]

- name: V-38493 Medium  Audit log directories must have mode 0755 or less permissive
  file: dest=/var/log/audit owner=root group=root mode=0750
  tags: [ 'cat2' , 'V-38493' , 'file_perms' , 'auditd' ]

- name: "V-38496 Medium  Default system accounts, other than root, must be locked"
  command: passwd -l {{ item }}
  with_items: system_users.stdout_lines
  tags: [ 'cat2' , 'V-38496' , 'accounts' ]

- name: V-38523 Medium  The system must not accept IPv4 source-routed packets on any interface
  sysctl: name=net.ipv4.conf.all.accept_source_route value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38523' , 'kernel_parameters' , 'network' , 'source_routed_packets' ]

# - name: V-38673 Medium  The operating system must ensure unauthorized, security-relevant configuration changes detected are tracked
# - name: V-38670  Medium  The operating system must detect unauthorized changes to software and information

- name: V-38671 Medium  The sendmail package must be removed
  yum: name=sendmail state=absent
  tags: [ 'cat2' , 'V-38671' , 'sendmail' , 'unauthorized_packages' ]

- name: V-38674 Medium  X Windows must not be enabled unless required
  lineinfile: state=present dest=/etc/inittab regexp='^id:' line='id:3:initdefault:' backup=yes
  when: not rhel6stig_xwindows_required
  tags: [ 'cat2' , 'V-38674' , 'xwindows' , 'gui' ]

- name: V-38630 Medium  The graphical desktop environment must automatically lock after 15 minutes of inactivity and the system must require user to re-authenticate to unlock the environment
  command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gnome-screensaver/idle_activation_enabled true
  ignore_errors: yes
  when: not rhel6stig_xwindows_required
  tags: [ 'cat2' , 'V-38630' , 'gui' , 'screen_lock' ]


# Get a list of interface config files. Exclude those with the current year in the name.
# This prevents Ansible from continually changing the backup files it creates since they
# are named like 'ifcfg-eth0.2014-07-18@13:19~' and will match the glob.
- name: List interface config files
  shell: ls /etc/sysconfig/network-scripts/ifcfg-eth* | grep -v $(date +%Y)
  changed_when: false
  ignore_errors: yes
  register: interface_config_files
  tags: [ 'cat2' , 'V-38679' , 'network' , 'dhcp' ]

- name: V-38679 Medium  The DHCP client must be disabled if not needed
  lineinfile: "state=present dest={{ item }} regexp='^BOOTPROTO=' line='BOOTPROTO=\"static\"' backup=yes"
  with_items: interface_config_files.stdout_lines
  register: dhcp_change
  when: interface_config_files.stdout
  tags: [ 'cat2' , 'V-38679' , 'network' , 'dhcp' ]

- name: Changed to static IP address
  pause: prompt="The network configuration was changed from dynamic to static. You need to set an IP address in /etc/sysconfig/network-scripts/ifcfg-eth*. Press Enter to continue"
  when: dhcp_change.changed and not rhel6stig_fullauto
  tags: [ 'cat2' , 'V-38679' , 'network' , 'dhcp' ]

- name: V-38475 Medium  The system must require passwords to contain a minimum of 14 characters
  lineinfile: "state=present dest=/etc/login.defs regexp='^rhel6stig_pass_MIN_LEN' line='rhel6stig_pass_MIN_LEN    {{ rhel6stig_pass_min_length }}' backup=yes"
  tags: [ 'cat2' , 'V-38475' , 'passwords' ]

- name: V-38477 Medium  Users must not be able to change passwords more than once every 24 hours
  lineinfile: "state=present dest=/etc/login.defs regexp='^rhel6stig_pass_MIN_DAYS' line='rhel6stig_pass_MIN_DAYS   {{ rhel6stig_pass_min_days }}' backup=yes"
  tags: [ 'cat2' , 'V-38477' , 'passwords' ]

- name: V-38472 Medium  All system command files must be owned by root
  file: dest={{ item }} owner=root recurse=yes
  with_items:
    - /bin
    - /usr/bin
    - /usr/local/bin
    - /sbin
    - /usr/sbin
    - /usr/local/sbin
  tags: [ 'cat2' , 'V-38472' , 'file_perms' ]

- name: V-38479 Medium  User passwords must be changed at least every 60 days
  lineinfile: "state=present dest=/etc/login.defs regexp='^rhel6stig_pass_MAX_DAYS' line='rhel6stig_pass_MAX_DAYS   {{ rhel6stig_pass_max_days }}' backup=yes"
  tags: [ 'cat2' , 'V-38479' , 'passwords' ]

- name: V-38542 Medium  The system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces
  sysctl: name=net.ipv4.conf.all.rp_filter value=1 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38542' , 'kernel_parameters' , 'network' , 'reverse_path_filter' ]

- name: V-38544 Medium  The system must use a reverse-path filter for IPv4 network traffic when possible by default.
  sysctl: name=net.ipv4.conf.default.rp_filter value=1 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38544' , 'kernel_parameters' , 'network' , 'reverse_path_filter' ]


# Get a list of all repo files on remote system
# Ideally, this would be done using with_fileglobs instead of two separate actions,
# but with_fileglobs only operates on the host filesystem, not the remote.
- name: List yum repository files
  shell: ls /etc/yum.repos.d/*.repo
  changed_when: false
  register: yum_repos
  ignore_errors: yes
  tags: [ 'cat2' , 'V-38483' , 'rpm' , 'gpgcheck' , 'test' ]

- name: V-38483 Medium  The system package management tool must cryptographically verify the authenticity of system software packages during installation
  replace: backup=yes dest={{ item }} regexp='^gpgcheck=0' replace='gpgcheck=1'
  tags: [ 'cat2' , 'V-38483' , 'rpm' , 'gpgcheck' ]
  with_flattened:
    - /etc/yum.conf
    - yum_repos.stdout_lines


- name: V-38546 Medium  The IPv6 protocol handler must not be bound to the network stack unless needed
  copy: backup=yes src=disable-ipv6.conf dest=/etc/modprobe.d/disable-ipv6.conf owner=root group=root mode=0644
  when: not rhel6stig_ipv6_in_use
  tags: [ 'cat2' , 'V-38546' , 'ipv6' ]

- name: V-38548 Medium  The system must ignore ICMPv6 redirects by default
  sysctl: name=net.ipv6.conf.default.accept_redirects value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38548' , 'icmp_redirects' , 'kernel_parameters' , 'network' , 'ipv6' ]


# DOD login banner for GUI environments
- name: "V-38689 Medium  The Department of Defense (DoD) login banner must be displayed immediately prior to, or as part of, graphical desktop environment login prompts"
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type string --set /apps/gdm/simple-greeter/banner_message_text '  You are accessing a U.S. Government (USG) Information System (IS) that is provided for USG-authorized use only.\n  By using this IS (which includes any device attached to this IS), you consent to the following conditions:\n\n  The USG routinely intercepts and monitors communications on this IS for purposes including, but not limited to, penetration testing, COMSEC monitoring, network operations and defense, personnel misconduct (PM), law enforcement (LE), and counterintelligence (CI) investigations.\n  At any time, the USG may inspect and seize data stored on this IS.\n  Communications using, or data stored on, this IS are not private, are subject to routine monitoring, interception, and search, and may be disclosed or used for any USG-authorized purpose.\n  This IS includes security measures (e.g., authentication and access controls) to protect USG interests -- not for your personal benefit or privacy.\n  Notwithstanding the above, using this IS does not constitute consent to PM, LE or CI investigative searching or monitoring of the content of privileged communications, or work product, related to personal representation or services by attorneys, psychotherapists, or clergy, and their assistants. Such communications and work product are private and confidential. See User Agreement for details.'"
  when: rhel6stig_xwindows_required
  tags: [ 'cat2' , 'V-38689' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]
  notify: restart gdm

- name: "V-38688  Medium  A login banner must be displayed immediately prior to, or as part of, graphical desktop environment login prompts."
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gdm/simple-greeter/banner_message_enable true"
  when: rhel6stig_xwindows_required
  tags: [ 'cat2' , 'V-38688' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]
  notify: restart gdm

- name: V-38689 Medium  Left justify banner text on graphical logon screen
  lineinfile: state=present backup=yes dest=/usr/share/gdm/gdm-greeter-login-window.ui regexp='^(.*)<property name="justify">\w+</property>' line='\1<property name="justify">left</property>' backrefs=yes
  when: rhel6stig_xwindows_required
  tags: [ 'cat2' , 'V-38689' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]
  notify: restart gdm

- name: ????? Medium  Disable restart buttons on graphical logon screen
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gdm/simple-greeter/disable_restart_buttons true"
  when: rhel6stig_xwindows_required
  tags: [ 'cat2' , '?????' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]
  notify: restart gdm

- name: ????? Medium  Disable user list on graphical logon screen
  command: "gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gdm/simple-greeter/disable_user_list true"
  when: rhel6stig_xwindows_required
  tags: [ 'cat2' , '?????' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]
  notify: restart gdm


- name: V-38686  Medium  The system's local firewall must implement a deny-all, allow-by-exception policy for forwarded packets
  lineinfile: "state=present backup=yes dest=/etc/sysconfig/iptables regexp=':FORWARD' line=':FORWARD DROP [0:0]'"
  tags: [ 'cat2' , 'V-38686' , 'firewall' ]
  notify: restart iptables

- name: V-38682 Medium  The Bluetooth kernel module must be disabled
  kernel_blacklist: name={{ item }}
  with_items:
    - bluetooth
    - net-pf-31
  tags: [ 'V-38682' , 'kernel_modules' , 'bluetooth' ]

- name: V-38609 Medium  The TFTP service must not be running
  lineinfile: "state=present backup=yes dest=/etc/xinetd.d/tftp regexp='disable.*=' line='\tdisable\t\t\t= yes'"
  ignore_errors: yes
  when: not rhel6stig_tftp_required
  tags: [ 'V-38609' , 'tftp-server' , 'unsecure_services' ]
  notify: reload xinetd

- name: V-38606 Medium  The tftp-server package must not be installed
  yum: name=tftp-server state=absent
  when: not rhel6stig_tftp_required
  tags: [ 'V-38606' , 'tftp-server' , 'unauthorized_packages' ]

- name: V-38605 Medium  The cron service must be running
  service: name=crond state=started enabled=yes
  tags: [ 'V-38605' , 'cron' , 'services' , 'mandatory_services' ]

- name: V-38604 Medium  The ypbind service must not be running
  service: name=ypbind state=stopped enabled=no
  ignore_errors: yes
  tags: [ 'V-38604' , 'service' , 'unsecure_services' , 'ypbind' ]

- name: V-38603 Medium  The ypserv package must not be installed
  yum: name=ypserv state=absent
  tags: [ 'V-38603' , 'unauthorized_packages' , 'ypserv' ]

- name: V-38601 Medium  The system must not send ICMPv4 redirects from any interface
  sysctl: name=net.ipv4.conf.all.send_redirects value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38544' , 'icmp_redirects' , 'kernel_parameters' , 'network' ]

- name: V-38600 Medium  The system must not send ICMPv4 redirects by default
  sysctl: name=net.ipv4.conf.default.send_redirects value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38600' , 'icmp_redirects' , 'kernel_parameters' , 'network' ]

- name: V-38449 Medium  The /etc/gshadow file must have mode 0000
        V-38448 Medium  The /etc/gshadow file must be group-owned by root
  file: path=/etc/gshadow owner=root group=root mode=0000
  tags: [ 'V-38449' , 'V-38448' , 'file_perms' ]

- name: V-38579 Medium  The system boot loader configuration file(s) must be owned by root
  file: path=/boot/grub/grub.conf owner=root group=root mode=0600
  tags: [ 'V-38579' , 'grub' , 'file_perms' ]

- name: V-38613 Medium  The system must not permit root logins using remote access programs such as ssh
  lineinfile: "state=present backup=yes dest=/etc/ssh/sshd_config regexp='^(#)?PermitRootLogin' line='PermitRootLogin no'"
  tags: [ 'V-38613' , 'ssh' , 'config' ]
  notify: restart ssh

- name: V-38577 Medium  The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (libuser.conf)
  lineinfile: "state=present backup=yes dest=/etc/libuser.conf regexp='crypt_style' line='crypt_style = sha512'"
  tags: [ 'V-38577' , 'passwords' ]

- name: V-38576 Medium  The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (login.defs)
  lineinfile: "state=present backup=yes dest=/etc/login.defs regexp='ENCRYPT_METHOD' line='ENCRYPT_METHOD SHA512 '"
  tags: [ 'V-38576' , 'passwords' ]

- name: V-38489 Medium  A file integrity tool must be installed
  yum: name=aide state=present
  tags: [ 'V-38489' , 'file_integrity' , 'aide' ]

- name: V-38698 Medium  The operating system must employ automated mechanisms to detect the presence of unauthorized software on organizational information systems and notify designated organizational officials in accordance with the organization defined frequency
  cron: name='Run AIDE integrity check once a month' day=7 hour=02 minute=10 job='/usr/sbin/aide --check'
  tags: [ 'V-38698' , 'cron' , 'file_integrity' , 'aide' ]

- name: "V-38519 Medium  All rsyslog-generated log files must be group-owned by root\n
         V-38518  Medium  All rsyslog-generated log files must be owned by root."
  file: dest={{ item }} owner=root group=root
  with_items:
    - /var/log/messages
    - /var/log/secure
    - /var/log/maillog
    - /var/log/cron
    - /var/log/spooler
    - /var/log/boot.log
  tags: [ 'V-38519' , 'file_perms' ]

- name: "V-38517 Medium  The Transparent Inter-Process Communication (TIPC) protocol must be disabled unless required
         V-38515  Medium  The Stream Control Transmission Protocol (SCTP) must be disabled unless required\n
         V-38514  Medium  The Datagram Congestion Control Protocol (DCCP) must be disabled unless required"
  kernel_blacklist: name={{ item }}
  with_items:
    - tipc
    - sctp
    - dccp
  tags: [ 'V-38517' , 'V-38515' , 'V-38514' , 'tipc' , 'sctp' , 'dccp' , 'kernel_modules' ]

- name: V-38691 Medium  The Bluetooth service must be disabled
  service: name=bluetooth state=stopped enabled=no
  ignore_errors: yes
  tags: [ 'V-38691' , 'bluetooth' ]

- name: V-38511 Medium  IP forwarding for IPv4 must not be enabled, unless the system is a router
  sysctl: name=net.ipv4.ip_forward value=0 state=present reload=yes ignoreerrors=yes
  when: not rhel6stig_system_is_router
  tags: [ 'V-38511' , 'kernel_parameters' , 'network' ]

- name: V-38597 Medium  The system must limit the ability of processes to have simultaneous write and execute access to memory
  sysctl: name=kernel.exec-shield value=1 state=present reload=yes ignoreerrors=yes
  tags: [ 'V-38597' , 'kernel_parameters' , 'test' ]

# --- BREAK --- #


- name: V-38532 Medium  The system must not accept ICMPv4 secure redirect packets by default.
  sysctl: name=net.ipv4.conf.default.secure_redirects value=0 state=present reload=yes ignoreerrors=yes
  tags: [ 'cat2' , 'V-38544' , 'icmp_redirects' , 'kernel_parameters' , 'network' ]

# --- BREAK --- #

- name: V-38586 Medium  The system must require authentication upon booting into single-user and maintenance modes.
  lineinfile: state=present backup=yes dest=/etc/sysconfig/init regexp='^(#)?SINGLE' line='SINGLE=/sbin/sulogin'
  tags: [ 'cat2' , 'V-38586' , 'root_access' ]