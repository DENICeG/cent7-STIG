---
# V-38499 is checked but not automatically patched, please see not_automated.yml
# V-38500 is checked but not automatically patched, please see not_automated.yml
# V-38520 is checked but not automatically patched, please see not_automated.yml
# V-38521 is checked but not automatically patched, please see not_automated.yml
# V-38658 is not implemented yet
# V-51875 is not implemented yet
# V-54381 is not implemented yet

- name: "MEDIUM | V-38443 | AUDIT | The /etc/gshadow file must be owned by root.\n
     \t\tMEDIUM | V-38448 | AUDIT | The /etc/gshadow file must be group-owned by root.\n
     \t\tMEDIUM | V-38449 | AUDIT | The /etc/gshadow file must have mode 0000"
  stat:
      path: /etc/gshadow
  ignore_errors: yes
  changed_when: no
  register: gshadow_stat_audit
  failed_when: "gshadow_stat_audit.stat.uid != 0 
             or gshadow_stat_audit.stat.gid != 0 
             or '0000' not in gshadow_stat_audit.stat.mode"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38449
    - V-38448
    - V-38443
    - file_perms

- name: "MEDIUM | V-38443 | PATCH | The /etc/gshadow file must be owned by root.\n
     \t\tMEDIUM | V-38448 | PATCH | The /etc/gshadow file must be group-owned by root.\n
     \t\tMEDIUM | V-38449 | PATCH | The /etc/gshadow file must have mode 0000"
  file:
      path: /etc/gshadow
      owner: root
      group: root
      mode: "u-rwx,g-rwx,o-rwx"
  when: gshadow_stat_audit.failed
  tags:
    - cat2
    - patch
    - medium
    - V-38443
    - V-38448
    - V-38449
    - file_perms

- name: "MEDIUM | V-38450 | AUDIT | The /etc/passwd file must be owned by root.\n
     \t\tMEDIUM | V-38451 | AUDIT | The /etc/passwd file must be group-owned by root.\n
     \t\tMEDIUM | V-38457 | AUDIT | The /etc/passwd file must have mode 0644 or less permissive"
  stat:
      path: /etc/passwd
  ignore_errors: yes
  changed_when: no
  register: passwd_stat_audit
  failed_when: "passwd_stat_audit.stat.uid != 0 
             or passwd_stat_audit.stat.gid != 0 
             or '0644' not in passwd_stat_audit.stat.mode"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38450
    - V-38451
    - V-38457
    - file_perms

- name: "MEDIUM | V-38450 | PATCH | The /etc/passwd file be owned by root\n
     \t\tMEDIUM | V-38451 | PATCH | The /etc/passwd file be group-owned by root\n
     \t\tMEDIUM | V-38457 | PATCH | The /etc/passwd file must have mode 0644 or less permissive"
  file:
      path: /etc/passwd
      owner: root
      group: root
      mode: "u-x,g-wx,o-wx"
  when: passwd_stat_audit.failed
  tags:
    - medium
    - cat2
    - V-38450
    - V-38451
    - V-38457
    - patch
    - file_perms

- name: "MEDIUM | V-38458 | AUDIT | The /etc/group file must be owned by root.\n
     \t\tMEDIUM | V-38459 | AUDIT | The /etc/group file must be group-owned by root.\n
     \t\tMEDIUM | V-38461 | AUDIT | The /etc/group file must have mode 0644 or less permissive"
  stat:
      path: /etc/group
  ignore_errors: yes
  changed_when: no
  register: group_stat_audit
  failed_when: "group_stat_audit.stat.uid != 0 
             or group_stat_audit.stat.gid != 0 
             or '0644' not in group_stat_audit.stat.mode"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38458
    - V-38459
    - V-38461
    - file_perms

- name: "MEDIUM | V-38458 | PATCH | The /etc/group file must be owned by root.\n
     \t\tMEDIUM | V-38459 | PATCH | The /etc/group file must be group-owned by root.\n
     \t\tMEDIUM | V-38461 | PATCH | The /etc/group file must have mode 0644 or less permissive"
  file:
      path: /etc/group
      owner: root
      group: root
      mode: "u-x,g-wx,o-wx"
  when: group_stat_audit.failed
  tags:
    - medium
    - cat2
    - V-38458
    - V-38459
    - V-38461
    - patch
    - file_perms

- name: "MEDIUM | V-38470 | AUDIT | The audit system must alert designated staff members when the audit storage volume approaches capacity.."
  shell: grep ^space_left_action /etc/audit/auditd.conf | cut -d = -f 2 | sed -e 's/ //g'
  ignore_errors: yes
  changed_when: no
  register:  space_left_action_audit
  failed_when: "space_left_action_audit.stdout_lines|length < 1 
            or '{{ cent7stig_auditd_config['space_left_action'] }}' not in space_left_action_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38470
    - auditd

- name: "MEDIUM | V-38470 | PATCH | The audit system must alert designated staff members when the audit storage volume approaches capacity.."
  lineinfile:
      regexp: '^(#)?space_left_action'
      line: "space_left_action = {{ cent7stig_auditd_config['space_left_action'] }}"
      dest: /etc/audit/auditd.conf
  notify:
    - start auditd
    - reload auditd
  when: space_left_action_audit.failed
  tags:
      - medium
      - cat2
      - V-38470
      - patch
      - auditd

- name: "MEDIUM | V-38475 | AUDIT | The system must require passwords to contain a minimum of 14 characters."
  shell: grep -E '^PASS_MIN_LEN' /etc/login.defs | awk '{print $2}'
  ignore_errors: yes
  changed_when: no
  register: min_pwd_len_audit
  failed_when: "min_pwd_len_audit.stdout|int < {{ cent7stig_pass_min_length|int }}"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38475
    - passwords

- name: "MEDIUM | V-38475 | PATCH | The system must require passwords to contain a minimum of 14 characters."
  lineinfile:
      regexp: '(^PASS_MIN_LEN)\s*(\d*)'
      line: '\1 {{ cent7stig_pass_min_length }}'
      dest: /etc/login.defs
      backrefs: yes
  when: min_pwd_len_audit.failed
  tags:
      - cat2
      - medium
      - V-38475
      - passwords
      - patch

- name: "MEDIUM | V-38477 | AUDIT | Users must not be able to change passwords more than once every 24 hours."
  shell: grep -E '^PASS_MIN_DAYS' /etc/login.defs | awk '{print $2}'
  ignore_errors: yes
  changed_when: no
  register: pwd_min_days_audit
  failed_when: "pwd_min_days_audit.stdout|int < {{ cent7stig_pass_min_days|int }}"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38477
    - passwords

- name: "MEDIUM | V-38477 | PATCH | Users must not be able to change passwords more than once every 24 hours."
  lineinfile:
      regexp: '(^PASS_MIN_DAYS)\s*(\d*)'
      line: '\1 {{ cent7stig_pass_min_days }}'
      dest: /etc/login.defs
      backrefs: yes
  when: pwd_min_days_audit.failed
  tags:
      - cat2
      - medium
      - V-38477
      - passwords
      - patch

- name: "MEDIUM | V-38479 | AUDIT | User passwords must be changed at least every 60 days."
  shell: grep -E '^PASS_MAX_DAYS' /etc/login.defs | awk '{print $2}'
  ignore_errors: yes
  changed_when: no
  register: pwd_max_days_audit
  failed_when: "pwd_max_days_audit.stdout|int > {{ cent7stig_pass_max_days|int }}"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38479
    - passwords

- name: "MEDIUM | V-38479 | PATCH | User passwords must be changed at least every 60 days."
  lineinfile:
      regexp: '(^PASS_MAX_DAYS)\s*(\d*)'
      line: '\1 {{ cent7stig_pass_max_days }}'
      dest: /etc/login.defs
      backrefs: yes
  when: pwd_max_days_audit.failed
  tags:
      - cat2
      - medium
      - V-38479
      - passwords
      - patch

- name: "MEDIUM | V-38483 | AUDIT | The system package management tool must cryptographically verify the authenticity of system software packages during installation."
  shell: find /etc/yum{.conf,.repos.d/*.repo} -exec grep -ls '^gpgcheck=0' {} \;
  ignore_errors: yes
  changed_when: no
  register: repo_crypto_check_audit
  failed_when: "{{ repo_crypto_check_audit.stdout_lines|length }} > 0"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38483
    - rpm
    - yum
    - gpgcheck

- name: "MEDIUM | V-38483 | PATCH | The system package management tool must cryptographically verify the authenticity of system software packages during installation."
  replace:
      backup: yes
      dest: '{{ item }}'
      regexp: '^gpgcheck=0'
      replace: 'gpgcheck=1'
  with_flattened:
    - '{{ repo_crypto_check_audit.stdout_lines }}'
  when: repo_crypto_check_audit.failed
  tags:
      - cat2
      - medium
      - V-38483
      - rpm
      - gpgcheck
      - patch

- name: "MEDIUM | V-38489 | AUDIT | A file integrity tool must be installed."
  command: rpm -q aide
  ignore_errors: yes
  changed_when: no
  register: aide_installed_audit
  failed_when: "'is not installed' in aide_installed_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38489
    - aide
    - integrity

- name: "MEDIUM | V-38489 | PATCH | A file integrity tool must be installed."
  yum:
      name: aide
      state: present
  when: 
      - cent7stig_install_packages
      - aide_installed_audit.failed
  tags:
      - medium
      - cat2
      - V-38489
      - audit
      - aide
      - integrity

- name: "MEDIUM | V-38490 | AUDIT | The operating system must enforce requirements for the connection of mobile devices to operating systems"
  shell: find /etc/modprobe{.conf,.d/*} -exec grep -ls '^install usb-storage /bin/true' {} \;
  ignore_errors: yes
  changed_when: no
  register: usb_reqs_audit
  failed_when: "{{ usb_reqs_audit.stdout_lines|length }} < 1"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38490
    - mobile_devices
    - usb_devices
    - kernel_modules

- name: "MEDIUM | V-38490 | PATCH | The operating system must enforce requirements for the connection of mobile devices to operating systems"
  lineinfile:
      state: present
      create: yes
      line: install usb-storage /bin/true
      dest: /etc/modprobe.d/disable-usb.conf
      owner: root
      group: root
      mode: "0644"
  when: usb_reqs_audit.failed
  tags:
      - medium
      - cat2
      - V-38490
      - mobile_devices
      - usb_devices
      - kernel_modules
      - patch

- name: "MEDIUM | V-38492 | AUDIT | The system must prevent the root account from logging in from virtual consoles."
  command: grep '^vc/[0-9]' /etc/securetty
  ignore_errors: yes
  changed_when: no
  register: vc_root_login_audit
  failed_when: vc_root_login_audit.stdout_lines|length > 0
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38492
    - virtual_consoles
    - logon_settings
    - tty
    - root_access

- name: "MEDIUM | V-38492 | PATCH | The system must prevent the root account from logging in from virtual consoles"
  lineinfile:
      state: absent
      dest: /etc/securetty
      regexp: '^.*vc/?\d'
      backup: yes
  when: vc_root_login_audit.failed
  tags:
      - cat2
      - V-38492
      - root_access
      - logon_settings
      - tty
      - virtual_consoles
      - medium
      - patch

- name: "MEDIUM | V-38495 | AUDIT | Audit log files must be owned by root."
  shell: grep "^log_file" /etc/audit/auditd.conf|sed 's/^[^/]*//; s/[^/]*$//' | xargs -I % find % -type f ! -user root
  ignore_errors: yes
  changed_when: no
  register: audit_log_dir_owner_audit
  failed_when: "{{ audit_log_dir_owner_audit.stdout_lines|length }} > 0" 
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38495
    - file_perms
    - auditd
    - always

- name: "MEDIUM | V-38495 | PATCH | Audit log files must be owned by root."
  file:
      state: file
      owner: root
      path: "{{ item }}"
  with_items: '{{ audit_log_dir_owner_audit.stdout_lines }}'
  when: audit_log_dir_owner_audit.failed
  tags:
      - cat2
      - V-38495
      - medium
      - file_perms
      - auditd
      - patch

- name: "MEDIUM | V-38498 | AUDIT | Audit log files must have mode 0640 or less permissive."
  shell: grep "^log_file" /etc/audit/auditd.conf|sed s/^[^\/]*//|xargs stat -c %n | xargs -I % find % -perm /137
  ignore_errors: yes
  changed_when: no
  register: audit_log_file_perms_audit
  failed_when: "{{ audit_log_file_perms_audit.stdout_lines|length }} > 0"
  tags:
    - medium
    - cat2
    - audit
    - always
    - auditd
    - logs
    - V-38498
    - file_perms

- name: "MEDIUM | V-38498 | PATCH | Audit log files must have mode 0640 or less permissive."
  file:
      state: file
      path: "{{ item }}"
      mode: "u-x,g-wx,o-rwx"
  with_items: '{{ audit_log_file_perms_audit.stdout_lines }}'
  when: audit_log_file_perms_audit.failed
  tags:
      - medium
      - cat2
      - auditd
      - patch
      - logs
      - V-38498
      - file_perms

# --------------------------------   TBD   --------------------------------
# Todo: pam-module not working
#
#- name: "MEDIUM | V-38501 | AUDIT | The system must disable accounts after excessive login failures within a 15-minute interval."
#  shell: grep -h pam_faillock /etc/pam.d/system-auth /etc/pam.d/password-auth | grep fail_interval | awk -F'=' '{print $NF}'
#  ignore_errors: yes
#  changed_when: no
#  register: login_failures_interval
#  failed_when: true
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#    - logon_settings
#    - V-38501
#    - pam
#
#- name: "MEDIUM | V-38501 | AUDIT | The system must disable accounts after excessive login failures within a 15-minute interval."
#  shell: grep -hG '^account\s*required\s*pam_faillock\.so' /etc/pam.d/system-auth /etc/pam.d/password-auth
#  ignore_errors: yes
#  changed_when: no
#  register: login_failures_account_require
#  failed_when: login_failures_account_require.stdout_lines|length > 0
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#    - logon_settings
#    - V-38501
#    - pam
#
#- name: "MEDIUM | V-38501 | AUDIT | The system must disable accounts after excessive login failures within a 15-minute interval."
#  assert:
#      that: 
#        - "{{ item | integer }} > 900"
#        - "{{ login_failures_account_require.stdout_lines | length }} == 2"
#  with_items: login_failures_interval.stdout_lines
#  ignore_errors: yes
#  changed_when: no
#  register: login_failures_interval_audit
#  failed_when: true
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#    - logon_settings
#    - V-38501
#    - pam
#
#- name: "MEDIUM | V-38501 | PATCH | The system must disable accounts after excessive login failures within a 15-minute interval."
#  pam:
#      service: "{{ item }}"
#      type: auth
#      control: required
#      pam_module: pam_faillock.so
#      before_line: auth sufficient pam_unix.so
#      arguments: preauth silent deny=3 unlock_time=604800 fail_interval=900
#      state: present
#  with_items:
#      - password-auth
#      - system-auth
#  tags:
#      - medium
#      - cat2
#      - logon_settings
#      - patch
#      - V-38501
#      - pam
#
#- name: "MEDIUM | V-38501 | PATCH | The system must disable accounts after excessive login failures within a 15-minute interval."
#  pam:
#      service: "{{ item }}"
#      type: auth
#      control: '[default=die]'
#      pam_module: pam_faillock.so
#      after_line: auth sufficient pam_unix.so
#      arguments: authfail deny=3 unlock_time=604800 fail_interval=900
#      state: present
#  with_items:
#      - password-auth
#      - system-auth
#  tags:
#      - medium
#      - cat2
#      - logon_settings
#      - patch
#      - V-38501
#      - pam
#
# ------------------------------------------------------------------------------------------

- name: "MEDIUM | V-38502 | AUDIT | The /etc/shadow file must be owned by root.\n
     \t\tMEDIUM | V-38503 | AUDIT | The /etc/shadow file must be group-owned by root.\n
     \t\tMEDIUM | V-38504 | AUDIT | The /etc/shadow file must have mode 0000."
  stat:
      path: /etc/shadow
  ignore_errors: yes
  changed_when: no
  register: shadow_stat_audit
  failed_when: "shadow_stat_audit.stat.uid != 0 
             or shadow_stat_audit.stat.gid != 0 
             or '0000' not in shadow_stat_audit.stat.mode"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38502
    - V-38503
    - V-38504
    - shadow
    - file_perms

- name: "MEDIUM | V-38502 | PATCH | The /etc/shadow file must be owned by root.\n
     \t\tMEDIUM | V-38503 | PATCH | The /etc/shadow file must be group-owned by root.\n
     \t\tMEDIUM | V-38504 | PATCH | The /etc/shadow file must have mode 0000."
  file:
      path: /etc/shadow
      state: file
      owner: root
      group: root
      mode: "0000"
  when: shadow_stat_audit.failed
  tags:
      - medium
      - cat2
      - V-38502
      - V-38503
      - V-38504
      - shadow
      - file_perms
      - patch

- name: "MEDIUM | V-38512 | AUDIT | The operating system must prevent public IPv4 access into an organizations internal networks except as appropriately mediated by managed interfaces employing boundary protection devices\n
     \t\tMEDIUM | V-38555 | AUDIT | The system must employ a local IPv4 firewall."
  command: /usr/bin/systemctl is-active iptables.service
  ignore_errors: yes
  changed_when: no
  register: iptables_audit
  failed_when: "'inactive' in iptables_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38512
    - V-38555
    - ipv4
    - network
    - firewall

- name: "MEDIUM | V-38512 | PATCH | The operating system must prevent public IPv4 access into an organizations internal networks except as appropriately mediated by managed interfaces employing boundary protection devices\n
     \t\tMEDIUM | V-38555 | PATCH | The system must employ a local IPv4 firewall."
  yum:
      name: 
          - iptables
          - iptables-services
      state: present
  when: 
      - cent7stig_install_packages
      - iptables_audit.failed
  tags:
      - V-38512
      - V-38555
      - ipv4
      - network
      - firewall
      - medium
      - cat2
      - patch

- name: "MEDIUM | V-38512 | PATCH | The operating system must prevent public IPv4 access into an organizations internal networks except as appropriately mediated by managed interfaces employing boundary protection devices\n
     \t\tMEDIUM | V-38555 | PATCH | The system must employ a local IPv4 firewall."
  service:
      name: '{{ item.name }}'
      enabled: '{{ item.enabled }}'
      state: '{{ item.state }}'
  with_items:
      - { name: 'iptables' , enabled: True , state: 'started' }
  when: iptables_audit.failed
  tags:
      - V-38512
      - V-38555
      - ipv4
      - network
      - firewall
      - medium
      - cat2
      - patch

- name: "MEDIUM | V-38513 | AUDIT | The systems local IPv4 firewall must implement a deny-all, allow-by-exception policy for inbound packets."
  shell: grep ":INPUT" /etc/sysconfig/iptables | awk '{print $2}'
  ignore_errors: yes
  changed_when: no
  register: ipv4_fw_deny_all_audit
  failed_when: "'DROP' not in  ipv4_fw_deny_all_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38513
    - ipv4
    - network
    - firewall

- name: "MEDIUM | V-38513 | PATCH | The systems local IPv4 firewall must implement a deny-all, allow-by-exception policy for inbound packets."
  lineinfile:
      state: present
      dest: /etc/sysconfig/iptables
      regexp: ':INPUT'
      line: ':INPUT DROP [0:0]'
  notify: restart iptables
  when: ipv4_fw_deny_all_audit.failed
  tags:
      - cat2
      - medium
      - V-38513
      - ipv4
      - firewall
      - network
      - patch

- name: "MEDIUM | V-38514 | AUDIT | The Datagram Congestion Control Protocol (DCCP) must be disabled unless required."
  command: grep -Rse "^install\s*dccp\s*/bin/true$" /etc/modprobe.conf /etc/modprobe.d
  ignore_errors: yes
  changed_when: no
  register: dccp_audit
  failed_when: "{{ dccp_audit.stdout_lines|length }} < 1"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38514
    - dccp
    - transport

- name: "MEDIUM | V-38514 | PATCH | The Datagram Congestion Control Protocol (DCCP) must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install dccp /bin/true
      dest: /etc/modprobe.d/disable-dccp.conf
      owner: root
      group: root
      mode: "0644"
  when: dccp_audit.failed
  tags:
      - V-38514
      - cat2
      - medium
      - dccp
      - transport
      - patch

- name: "MEDIUM | V-38515 | AUDIT | The Stream Control Transmission Protocol (SCTP) must be disabled unless required."
  command: grep -Rse "^install\s*sctp\s*/bin/true$" /etc/modprobe.conf /etc/modprobe.d
  ignore_errors: yes
  changed_when: no
  register: sctp_audit
  failed_when: "{{ sctp_audit.stdout_lines|length }} < 1"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38515
    - sctp
    - transport

- name: "MEDIUM | V-38515 | PATCH | The Stream Control Transmission Protocol (SCTP) must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install sctp /bin/true
      dest: /etc/modprobe.d/disable-sctp.conf
      owner: root
      group: root
      mode: "0644"
  when: sctp_audit.failed
  tags:
      - V-38515
      - cat2
      - medium
      - sctp
      - transport
      - patch

- name: "MEDIUM | V-38517 | AUDIT | The Transparent Inter-Process Communication (TIPC) protocol must be disabled unless required."
  command: grep -Rse "^install\s*tipc\s*/bin/true$" /etc/modprobe.conf /etc/modprobe.d
  ignore_errors: yes
  changed_when: no
  register: tipc_audit
  failed_when: "{{ sctp_audit.stdout_lines|length }} < 1"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38517
    - tipc

- name: "MEDIUM | V-38517 | PATCH | The Transparent Inter-Process Communication (TIPC) protocol must be disabled unless required."
  lineinfile:
      state: present
      create: yes
      line: install ticp /bin/true
      dest: /etc/modprobe.d/disable-tipc.conf
      owner: root
      group: root
      mode: "0644"
  when: tipc_audit.failed
  tags:
      - V-38517
      - cat2
      - medium
      - ticp
      - patch

- name: "MEDIUM | V-38518 | AUDIT | All rsyslog-generated log files must be owned by root."
  shell: grep -e "/" /etc/rsyslog.conf /etc/rsyslog.d/* | grep -v ':[#\$]' | sed 's/-//' | sed 's/[A-Za-z]*=//g' | sed 's/\"//g' | awk 'NF==2 {print $2}'
  changed_when: no
  register: rsyslog_logfiles
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38518
    - log_files
    - rsyslog

- name: "MEDIUM | V-38518 | AUDIT | All rsyslog-generated log files must be owned by root."
  stat:
      path: "{{ item }}"
  with_items: '{{ rsyslog_logfiles.stdout_lines }}'
  ignore_errors: yes
  changed_when: no
  register: rsyslog_logfiles_audit
  failed_when: "rsyslog_logfiles_audit.stat.uid != 0"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38518
    - log_files
    - rsyslog

- name: "MEDIUM | V-38518 | PATCH | All rsyslog-generated log files must be owned by root."
  file:
      path: "{{ item }}"
      owner: root
      follow: yes
      state: touch
  with_items: '{{ rsyslog_logfiles.stdout_lines }}'
  when: rsyslog_logfiles_audit|failed
  tags:
      - cat2
      - medium
      - V-38518
      - log_files
      - rsyslog
      - patch

- name: "MEDIUM | V-38511 | AUDIT | IP forwarding for IPv4 must not be enabled, unless the system is a router."
  shell: sysctl net.ipv4.ip_forward | awk '{print $3}'
  ignore_errors: yes
  changed_when: no
  register: ipv4_ip_forwarding_audit
  failed_when: 
      - "ipv4_ip_forwarding_audit.stdout|int > 0"
      - not cent7stig_system_is_router
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38511
    - ip_forward
    - ipv4

- name: "MEDIUM | V-38511 | PATCH | IP forwarding for IPv4 must not be enabled unless the system is a router"
  sysctl:
      name: net.ipv4.ip_forward
      value: 0
      state: present
      sysctl_set: yes
      reload: yes
  when: 
      - not cent7stig_system_is_router
      - ipv4_ip_forwarding_audit.failed
  tags:
      - cat2
      - V-38511
      - kernel_parameters
      - network
      - medium
      - patch

- name: "MEDIUM | V-38523 | AUDIT | The system must not accept IPv4 source-routed packets on any interface.\n
     \t\tMEDIUM | V-38524 | AUDIT | The system must not accept ICMPv4 redirect packets on any interface.\n
     \t\tMEDIUM | V-38526 | AUDIT | The system must not accept ICMPv4 secure redirect packets on any interface.\n
     \t\tMEDIUM | V-38529 | AUDIT | The system must not accept IPv4 source-routed packets by default.\n
     \t\tMEDIUM | V-38532 | AUDIT | The system must not accept ICMPv4 secure redirect packets by default.\n
     \t\tMEDIUM | V-38539 | AUDIT | The system must be configured to use TCP syncookies when experiencing a TCP SYN flood.\n
     \t\tMEDIUM | V-38542 | AUDIT | The system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces.\n
     \t\tMEDIUM | V-38544 | AUDIT | The system must use a reverse-path filter for IPv4 network traffic when possible by default.\n
     \t\tMEDIUM | V-38548 | AUDIT | The system must ignore ICMPv6 redirects by default.\n
     \t\tMEDIUM | V-38600 | AUDIT | The system must not send ICMPv4 redirects by default.\n
     \t\tMEDIUM | V-38601 | AUDIT | The system must not send ICMPv4 redirects from any interface."

  shell: sysctl {{ item.name }} | awk '{print $3}'
  ignore_errors: yes
  changed_when: no
  register: sysctl_items
  with_items:
      - { ref: 'V-38523' , name: 'net.ipv4.conf.all.accept_source_route' , value: '0' }
      - { ref: 'V-38524' , name: 'net.ipv4.conf.all.accept_redirects' , value: '0' }
      - { ref: 'V-38526' , name: 'net.ipv4.conf.all.secure_redirects' , value: '0' }
      - { ref: 'V-38529' , name: 'net.ipv4.conf.default.accept_source_route' , value: '0' }
      - { ref: 'V-38532' , name: 'net.ipv4.conf.default.secure_redirects' , value: '0' }
      - { ref: 'V-38539' , name: 'net.ipv4.tcp_syncookies' , value: '1' }
      - { ref: 'V-38542' , name: 'net.ipv4.conf.all.rp_filter' , value: '1' }
      - { ref: 'V-38544' , name: 'net.ipv4.conf.default.rp_filter' , value: '1' }
      - { ref: 'V-38548' , name: 'net.ipv6.conf.default.accept_redirects' , value: '0' }
      - { ref: 'V-38600' , name: 'net.ipv4.conf.default.send_redirects' , value: '0' }
      - { ref: 'V-38601' , name: 'net.ipv4.conf.all.send_redirects' , value: '0' }
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38523
    - V-38524
    - V-38526
    - V-38529
    - V-38532
    - V-38539
    - V-38542
    - V-38544
    - V-38548
    - V-38600
    - V-38601
    - ipv4
    - ICMPv4
    - icmp
    - tcp
    - sysctl
    - kernel_parameters
    - network

- name: "MEDIUM | V-38523 | AUDIT | The system must not accept IPv4 source-routed packets on any interface.\n
     \t\tMEDIUM | V-38524 | AUDIT | The system must not accept ICMPv4 redirect packets on any interface.\n
     \t\tMEDIUM | V-38526 | AUDIT | The system must not accept ICMPv4 secure redirect packets on any interface.\n
     \t\tMEDIUM | V-38529 | AUDIT | The system must not accept IPv4 source-routed packets by default.\n
     \t\tMEDIUM | V-38532 | AUDIT | The system must not accept ICMPv4 secure redirect packets by default.\n
     \t\tMEDIUM | V-38539 | AUDIT | The system must be configured to use TCP syncookies when experiencing a TCP SYN flood.\n
     \t\tMEDIUM | V-38542 | AUDIT | The system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces.\n
     \t\tMEDIUM | V-38544 | AUDIT | The system must use a reverse-path filter for IPv4 network traffic when possible by default.\n
     \t\tMEDIUM | V-38548 | AUDIT | The system must ignore ICMPv6 redirects by default.\n
     \t\tMEDIUM | V-38600 | AUDIT | The system must not send ICMPv4 redirects by default.\n
     \t\tMEDIUM | V-38601 | AUDIT | The system must not send ICMPv4 redirects from any interface."
  assert:
    that: "{{ item.item.value|int }} == {{ item.stdout|int }}"
  ignore_errors: yes
  changed_when: no
  register: sysctl_items_audit
  with_items: "{{ sysctl_items.results }}"
  loop_control:
    label: "{{item.item.ref}}"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38523
    - V-38524
    - V-38526
    - V-38529
    - V-38532
    - V-38539
    - V-38542
    - V-38544
    - V-38548
    - V-38600
    - V-38601
    - ipv4
    - ICMPv4
    - icmp
    - tcp
    - sysctl
    - kernel_parameters
    - network

- name: "MEDIUM | V-38523 | PATCH | The system must not accept IPv4 source-routed packets on any interface.\n
     \t\tMEDIUM | V-38524 | PATCH | The system must not accept ICMPv4 redirect packets on any interface.\n
     \t\tMEDIUM | V-38526 | PATCH | The system must not accept ICMPv4 secure redirect packets on any interface.\n
     \t\tMEDIUM | V-38529 | PATCH | The system must not accept IPv4 source-routed packets by default.\n
     \t\tMEDIUM | V-38532 | PATCH | The system must not accept ICMPv4 secure redirect packets by default.\n
     \t\tMEDIUM | V-38539 | PATCH | The system must be configured to use TCP syncookies when experiencing a TCP SYN flood.\n
     \t\tMEDIUM | V-38542 | PATCH | The system must use a reverse-path filter for IPv4 network traffic when possible on all interfaces.\n
     \t\tMEDIUM | V-38544 | PATCH | The system must use a reverse-path filter for IPv4 network traffic when possible by default.\n
     \t\tMEDIUM | V-38548 | PATCH | The system must ignore ICMPv6 redirects by default.\n
     \t\tMEDIUM | V-38600 | PATCH | The system must not send ICMPv4 redirects by default.\n
     \t\tMEDIUM | V-38601 | PATCH | The system must not send ICMPv4 redirects from any interface."
  sysctl:
      name: '{{ item.name }}'
      value: '{{ item.value }}'
      state: present
      sysctl_set: yes
      reload: yes
  with_items:
      - { ref: 'V-38523' , name: 'net.ipv4.conf.all.accept_source_route' , value: '0' }
      - { ref: 'V-38524' , name: 'net.ipv4.conf.all.accept_redirects' , value: '0' }
      - { ref: 'V-38526' , name: 'net.ipv4.conf.all.secure_redirects' , value: '0' }
      - { ref: 'V-38529' , name: 'net.ipv4.conf.default.accept_source_route' , value: '0' }
      - { ref: 'V-38532' , name: 'net.ipv4.conf.default.secure_redirects' , value: '0' }
      - { ref: 'V-38539' , name: 'net.ipv4.tcp_syncookies' , value: '1' }
      - { ref: 'V-38542' , name: 'net.ipv4.conf.all.rp_filter' , value: '1' }
      - { ref: 'V-38544' , name: 'net.ipv4.conf.default.rp_filter' , value: '1' }
      - { ref: 'V-38548' , name: 'net.ipv6.conf.default.accept_redirects' , value: '0' }
      - { ref: 'V-38600' , name: 'net.ipv4.conf.default.send_redirects' , value: '0' }
      - { ref: 'V-38601' , name: 'net.ipv4.conf.all.send_redirects' , value: '0' }
  when: sysctl_items_audit|failed
  tags:
      - medium
      - cat2
      - V-38523
      - V-38524
      - V-38526
      - V-38529
      - V-38532
      - V-38539
      - V-38542
      - V-38544
      - V-38548
      - V-38600
      - V-38601
      - patch
      - ipv4
      - ICMPv4
      - icmp
      - tcp
      - sysctl
      - kernel_parameters
      - network

- name: "MEDIUM | V-38546 | AUDIT | The IPv6 protocol handler must not be bound to the network stack unless needed."
  command: grep -Rse '^options\s*ipv6\s*disable=1$' /etc/modprobe.conf /etc/modprobe.d
  ignore_errors: yes
  changed_when: no
  register: ipv6_protocol_handler_bound_network_stack_audit
  failed_when: "{{ ipv6_protocol_handler_bound_network_stack_audit.stdout_lines|length }} < 1"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38546
    - ipv6
    - network

- name: "MEDIUM | V-38546 | PATCH | The IPv6 protocol handler must not be bound to the network stack unless needed."
  lineinfile:
      state: present
      create: yes
      line: options ipv6 disable=1
      dest: /etc/modprobe.d/disable-ipv6.conf
      owner: root
      group: root
      mode: "0644"
  when: ipv6_protocol_handler_bound_network_stack_audit.failed
  tags:
      - V-38546
      - cat2
      - medium
      - ipv6
      - network
      - audit

# --------------------------------   TBD   --------------------------------
# Todo: pam-module not working
#
#- name: "MEDIUM | V-38573 | AUDIT | The system must disable accounts after three consecutive unsuccessful logon attempts."
#  shell: grep -h pam_faillock /etc/pam.d/system-auth /etc/pam.d/password-auth | grep deny=3
#  ignore_errors: yes
#  changed_when: no
#  register: logon_attempts_audit
#  failed_when: true
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#     - V-38573
#     - logon_settings
#     - accounts
#     - pam
#
#- name: "MEDIUM | V-38573 | PATCH | The system must disable accounts after three consecutive unsuccessful logon attempts."
#  pam:
#      service: "{{ item }}"
#      type: auth
#      control: required
#      pam_module: pam_faillock.so
#      arguments: preauth silent deny=3 unlock_time=604800 fail_interval=900
#      before_line: auth sufficient pam_unix.so
#      state: present 
#  with_items:
#      - system-auth
#      - password-auth
#  tags:
#      - medium
#      - cat2
#      - V-38573
#      - logon_settings
#      - accounts
#      - patch
#      - pam
#
#- name: "MEDIUM | V-38573 | PATCH | The system must disable accounts after three consecutive unsuccessful logon attempts."
#  pam:
#      service: "{{ item }}"
#      type: auth
#      control: '[default=die]' 
#      pam_module: pam_faillock.so
#      arguments: authfail deny=3 unlock_time=604800 fail_interval=900 
#      after_line: auth sufficient pam_unix.so
#      state: present 
#  with_items:
#      - system-auth
#      - password-auth
#  tags:
#      - medium
#      - cat2
#      - V-38573
#      - logon_settings
#      - accounts
#      - patch
#      - pam
#
#- name: "MEDIUM | V-38573 | PATCH | The system must disable accounts after three consecutive unsuccessful logon attempts."
#  pam:
#      service: "{{ item }}"
#      type: account
#      control: required 
#      pam_module: pam_faillock.so
#      before_line: account required pam_unix.so     
#      state: present 
#  with_items:
#      - system-auth
#      - password-auth
#  tags:
#      - medium
#      - cat2
#      - V-38573
#      - logon_settings
#      - accounts
#      - patch
#      - pam
#
# -------------------------------------------------------------------------

#- name: "MEDIUM | V-38574 | AUDIT | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (system-auth)."
#  shell: find /etc/pam.d/ -type f -not -name '*.*' 
#  ignore_errors: yes
#  changed_when: no
#  register: pamd_files
#  failed_when: true
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#    - V-38574
#    - logon_settings
#    - accounts
#    - passwords
#    - pam
#
#- name: "MEDIUM | V-38574 | AUDIT | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (system-auth)."
#  shell: grep password -h /etc/pam.d/* | grep pam_unix.so | awk '{print $4}'
#  ignore_errors: yes
#  changed_when: no
#  register: pam_pwd_hash_audit
#  failed_when: true
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#    - V-38574
#    - logon_settings
#    - accounts
#    - passwords
#
#- name: "MEDIUM | V-38574 | PATCH | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (system-auth)."
#  # The PAM module doesn't make sense for this particular rule. Lineinfile works perfectly here.
#  lineinfile:
#      dest: "{{ item }}"
#      backrefs: yes
#      regexp: (^password\s*.*pam_unix.so.*)(md5|sha256|blowfish|bigcrypt)(.*) 
#      line: \1sha512\3
#      backup: yes
#  with_items: pamd_files.stdout_lines
#  tags:
#      - medium
#      - cat2
#      - V-38574
#      - logon_settings
#      - accounts
#      - passwords
#      - patch
#      - pam
#
# -------------------------------------------------------------------------

- name: "MEDIUM | V-38576 | AUDIT | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (login.defs)"
  shell: grep '^ENCRYPT_METHOD' /etc/login.defs | awk '{print $2}'
  ignore_errors: yes
  changed_when: no
  register: login_defs_audit
  failed_when: "'SHA512' not in login_defs_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38576
    - passwords

- name: "MEDIUM | V-38576 | PATCH | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (login.defs)"
  lineinfile: 
      regexp: '^(#)?ENCRYPT_METHOD' 
      line: 'ENCRYPT_METHOD SHA512'
      dest: /etc/login.defs 
  when: login_defs_audit.failed
  tags:
      - cat2
      - medium
      - patch
      - V-38576
      - passwords

- name: "MEDIUM | V-38577 | AUDIT | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (libuser.conf)"
  shell: grep ^crypt_style /etc/libuser.conf | awk '{print $3}'
  ignore_errors: yes
  changed_when: no
  register: libuser_audit
  failed_when: "'sha512' not in libuser_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38577
    - passwords

- name: "MEDIUM | V-38577 | PATCH | The system must use a FIPS 140-2 approved cryptographic hashing algorithm for generating account password hashes (libuser.conf)"
  ini_file:
      state: present 
      backup: yes 
      dest: /etc/libuser.conf 
      section: defaults
      option: crypt_style
      value: sha512 
  when: libuser_audit.failed
  tags:
      - cat2
      - medium
      - audit
      - V-38577
      - passwords

- name: "MEDIUM | V-38579 | AUDIT | The system boot loader configuration file(s) must be owned by root.\n
     \t\tMEDIUM | V-38581 | AUDIT | The system boot loader configuration file(s) must be group-owned by root.\n
     \t\tMEDIUM | V-38583 | AUDIT | The system boot loader configuration file(s) must have mode 0600 or less permissive."
  stat: 
      path: /boot/grub2/grub.cfg
  ignore_errors: yes
  changed_when: no
  register: grub_conf_audit
  failed_when: "grub_conf_audit.stat.uid != 0 
             or grub_conf_audit.stat.gid != 0 
             or '0600' not in grub_conf_audit.stat.mode"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38579
    - V-38581
    - V-38583
    - file_perms
    - grub

- name: "MEDIUM | V-38579 | PATCH | The system boot loader configuration file(s) must be owned by root.\n
     \t\tMEDIUM | V-38581 | PATCH | The system boot loader configuration file(s) must be group-owned by root\n
     \t\tMEDIUM | V-38583 | PATCH | The system boot loader configuration file(s) must have mode 0600 or less permissive." 
  file: 
      dest: /boot/grub2/grub.cfg
      owner: root
      group: root
      mode: "u-x,g-rwx,o-rwx"
      state: file
      follow: yes
  when: grub_conf_audit.failed
  tags:
      - cat2
      - medium
      - V-38579
      - V-38581
      - V-38583
      - file_perms
      - grub
      - patch 


- name: "MEDIUM | V-38580 | AUDIT | The audit system must be configured to audit the loading and unloading of dynamic kernel modules."
  shell: egrep -e "(-w |-F path=)/sbin/insmod" /etc/audit/audit.rules; egrep -e "(-w |-F path=)/sbin/modprobe" /etc/audit/audit.rules; egrep -e "(-w |-F path=)/sbin/rmmod" /etc/audit/audit.rules;grep -w "init_module" /etc/audit/audit.rules
  ignore_errors: yes
  changed_when: no
  register: dynamic_kernel_loading_audit
  failed_when: "'{{ item }}' not in dynamic_kernel_loading_audit.stdout"
  with_items:
      - "-w /sbin/insmod -p x -k modules"
      - "-w /sbin/rmmod -p x -k modules"
      - "-w /sbin/modprobe -p x -k modules"
      - "-a always,exit -F arch=b{{ansible_architecture | regex_replace('^.*_(\\d*)$','\\1')}} -S init_module -S delete_module -k modules"
  tags:
    - medium
    - cat2
    - audit
    - always
    - kernel
    - auditd
    - V-38580

- name: "MEDIUM | V-38580 | PATCH | The audit system must be configured to audit the loading and unloading of dynamic kernel modules."
  lineinfile:
      line: "{{ item }}"
      dest: /etc/audit/rules.d/audit.rules
  with_items:
      - "-w /sbin/insmod -p x -k modules"
      - "-w /sbin/rmmod -p x -k modules"
      - "-w /sbin/modprobe -p x -k modules"
      - "-a always,exit -F arch=b{{ansible_architecture | regex_replace('^.*_(\\d*)$','\\1')}} -S init_module -S delete_module -k modules"
  when: dynamic_kernel_loading_audit|failed
  notify: auditd rules reload
  tags:
    - cat2
    - medium
    - patch 
    - kernel
    - auditd
    - V-38580

# ToDo: If any xinted service is found to be on, skip these tasks since xinetd can be on if a service is using it
- name: "MEDIUM | V-38582 | AUDIT | The xinetd service must be disabled if no network services utilizing it are enabled"
  command: /usr/bin/systemctl is-enabled xinetd.service
  ignore_errors: yes
  changed_when: no
  register: xinetd_services_audit
  failed_when: "'No such file or directory' not in xinetd_services_audit.stderr"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38582
    - xinetd
    - services

- name: "MEDIUM | V-38582 | PATCH | The xinetd service must be disabled if no network services utilizing it are enabled" 
  service: 
      name: xinetd.service 
      state: stopped
      enabled: no 
  when: xinetd_services_audit.failed
  tags: 
      - cat2
      - medium 
      - V-38582
      - xinetd
      - services
      - patch

# ToDo: V-38585: Enforce change of (role-)default grub password
- name: "MEDIUM | V-38585 | AUDIT | The system boot loader must require authentication."
  shell: "grep 'password --encrypted' /boot/grub2/grub.cfg"
  ignore_errors: yes
  changed_when: no
  register: grub_auth_audit
  failed_when: grub_auth_audit.stdout_lines|length < 1
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38585
    - grub
    - passwords

- name: "MEDIUM | V-38585 | PATCH | The system boot loader must require authentication."
  grub_crypt:
      password: "{{ cent7stig_bootloader_password }}"
  register: grub_pass
  when: grub_auth_audit.failed
  tags:
      - cat2
      - medium
      - V-38585
      - grub
      - passwords
      - patch 

- name: "MEDIUM | V-38585 | PATCH | The system boot loader must require authentication."
  lineinfile:
      line: password --encrypted {{ grub_pass.passhash }} 
      dest: /boot/grub2/grub.cfg
      follow: yes
      insertafter: '^#\s*$'
      regexp: password
  when: grub_auth_audit.failed
  tags:
      - cat2
      - medium
      - V-38585
      - grub
      - passwords
      - patch 

- name: "MEDIUM | V-38586 | AUDIT | The system must require authentication upon booting into single-user and maintenance modes."
  command: grep "^SINGLE=/sbin/sulogin$" /etc/sysconfig/init
  ignore_errors: yes
  changed_when: no
  register: single_user_mode_auth_audit
  failed_when: single_user_mode_auth_audit.stdout_lines|length < 1
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38585
    - root_access

- name: "MEDIUM | V-38586 | PATCH | The system must require authentication upon booting into single-user and maintenance modes."
  lineinfile: 
      regexp: '^(#)?SINGLE=' 
      line: 'SINGLE=/sbin/sulogin'
      dest: /etc/sysconfig/init 
  when: single_user_mode_auth_audit.failed
  tags:
      - cat2
      - medium
      - V-38585
      - root_access 
      - patch 

- name: "MEDIUM | V-38588 | AUDIT | The system must not permit interactive boot."
  command: grep "^PROMPT=no" /etc/sysconfig/init
  ignore_errors: yes
  changed_when: no
  register: interactive_boot_audit
  failed_when: interactive_boot_audit.stdout_lines|length < 1
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38588
    - interactive_boot

- name: "MEDIUM | V-38588 | PATCH | The system must not permit interactive boot."
  lineinfile:
      regexp: '^(#)?PROMPT=' 
      line: 'PROMPT=no'
      dest: /etc/sysconfig/init 
  when: interactive_boot_audit.failed
  tags:
      - cat2
      - medium
      - V-38588
      - interactive_boot
      - patch

# --------------------------------   TBD   --------------------------------
# Todo: pam-module not working
#
#- name: "MEDIUM | V-38592 | AUDIT | The system must require administrator action to unlock an account locked by excessive failed login attempts." 
#  shell: grep -h pam_faillock /etc/pam.d/system-auth /etc/pam.d/password-auth | grep unlock_time
#  ignore_errors: yes
#  changed_when: no
#  register: admin_unlock_audit
#  failed_when: true
#  tags:
#    - medium
#    - cat2
#    - audit
#    - always
#    - V-38592
#    - logon_settings
#    - accounts
#    - pam
#
#- name: "MEDIUM | V-38592 | PATCH | The system must require administrator action to unlock an account locked by excessive failed login attempts." 
#  pam:
#      service: "{{ item }}"
#      type: auth
#      control: required
#      pam_module: pam_faillock.so
#      arguments: preauth silent deny=3 unlock_time=604800 fail_interval=900
#      before_line: auth sufficient pam_unix.so
#      state: present 
#  with_items:
#      - system-auth
#      - password-auth
#  tags:
#      - medium
#      - cat2
#      - V-38573
#      - logon_settings
#      - accounts
#      - patch
#      - pam
#
#- name: "MEDIUM | V-38592 | PATCH | The system must require administrator action to unlock an account locked by excessive failed login attempts." 
#  pam:
#      service: "{{ item }}"
#      type: auth
#      control: '[default=die]' 
#      pam_module: pam_faillock.so
#      arguments: authfail deny=3 unlock_time=604800 fail_interval=900 
#      after_line: auth sufficient pam_unix.so
#      state: present 
#  with_items:
#      - system-auth
#      - password-auth
#  tags:
#      - medium
#      - cat2
#      - V-38573
#      - logon_settings
#      - accounts
#      - patch
#      - pam
#
#- name: "MEDIUM | V-38592 | PATCH | The system must require administrator action to unlock an account locked by excessive failed login attempts." 
#  pam:
#      service: "{{ item }}"
#      type: account
#      control: required 
#      pam_module: pam_faillock.so
#      before_line: account required pam_unix.so     
#      state: present 
#  with_items:
#      - system-auth
#      - password-auth
#  tags:
#      - medium
#      - cat2
#      - V-38573
#      - logon_settings
#      - accounts
#      - patch
#      - pam
#
# -------------------------------------------------------------------------

- name: "MEDIUM | V-38603 | AUDIT | The ypserv package must not be installed."
  command: rpm -q ypserv
  ignore_errors: yes
  changed_when: no
  register: ypserv_audit
  failed_when: "'is not installed' not in ypserv_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38603
    - ypserv
    - packages

- name: "MEDIUM | V-38603 | PATCH | The ypserv package must not be installed."
  yum:
      name: ypserv
      state: absent
  when: ypserv_audit.failed
  tags:
      - medium
      - V-38603
      - patch 
      - cat2
      - ypserv
      - packages

- name: "MEDIUM | V-38604 | AUDIT | The ypbind service must not be running."
  command: /usr/bin/systemctl is-enabled ypbind.service 
  ignore_errors: yes
  changed_when: no
  register: ypbind_service_audit
  failed_when: "'No such file or directory' not in ypbind_service_audit.stderr"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38604
    - ypbind
    - services

- name: "MEDIUM | V-38604 | PATCH | The ypbind service must not be running."
  service:
      name: ypbind.service
      state: stopped
      enabled: no
  when: ypbind_service_audit.failed
  tags:
      - medium
      - V-38604
      - patch
      - cat2
      - ypbind
      - services

- name: "MEDIUM | V-38605 | AUDIT | The cron service must be running"
  command: /usr/bin/systemctl is-enabled crond.service 
  ignore_errors: yes
  changed_when: no
  register: crond_status_audit
  failed_when: "'inactive' in crond_status_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - cron
    - V-38605
    - services

- name: "MEDIUM | V-38605 | PATCH | The cron service must be running"
  service:
      name: crond.service
      state: started
      enabled: yes
  tags:
      - medium
      - cat2
      - cron
      - patch 
      - V-38605
      - services

- name: "MEDIUM | V-38606 | AUDIT | The tftp-server package must not be installed unless required."
  command: rpm -q tftp-server
  ignore_errors: yes
  changed_when: no
  register: tftp_server_install_audit
  failed_when:
      - "'is not installed' not in tftp_server_install_audit.stdout"
      - not cent7stig_tftp_required
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38606
    - tftp
    - packages

- name: "MEDIUM | V-38606 | PATCH | The tftp-server packages must not be intalled unless required."
  yum:
      name: tftp-server
      state: absent
  when: 
      - tftp_server_install_audit.failed 
      - not cent7stig_tftp_required
  tags:
      - medium
      - cat2
      - V-38606
      - tftp
      - packages
      - patch

# V-38613 will break automation, and therefor be issued as post task
- name: "MEDIUM | V-38611 | AUDIT | The SSH daemon must ignore .rhosts files.\n
     \t\tMEDIUM | V-38612 | AUDIT | The SSH daemon must not allow host-based authentication\n
     \t\tMEDIUM | V-38613 | AUDIT | The system must not permit root logins using remote access programs such as ssh\n
     \t\tMEDIUM | V-38615 | AUDIT | The SSH daemon must be configured with the Department of Defense (DoD) login banner."
  command: grep "^{{ item.ln }}" /etc/ssh/sshd_config 
  ignore_errors: yes
  changed_when: no
  register: cat2_sshd_config_audit
  with_items:
    - { ref: 'V-38611' , st: 'present', rx: "^(#)?IgnoreRhosts", ln: "IgnoreRhosts yes" }
    - { ref: 'V-38612' , st: 'present', rx: "^(#)?HostbasedAuthentication", ln: "HostbasedAuthentication no" }
#    - { ref: 'V-38613' , st: 'present', rx: "^(#)?PermitRootLogin", ln: "PermitRootLogin no" }
    - { ref: 'V-38615' , st: 'present', rx: "^(#)?Banner", ln: "Banner /etc/issue" }
    - { ref: 'V-38615' , st: 'present', rx: "^(#)?PrintLastLog", ln: "PrintLastLog yes" }
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38611
    - V-38612
    - V-38613
    - V-38615
    - ssh

- name: "MEDIUM | V-38611 | PATCH | The SSH daemon must ignore .rhosts files.\n
     \t\tMEDIUM | V-38612 | PATCH | The SSH daemon must not allow host-based authentication\n
     \t\tMEDIUM | V-38613 | PATCH | The system must not permit root logins using remote access programs such as ssh\n
     \t\tMEDIUM | V-38615 | PATCH | The SSH daemon must be configured with the Department of Defense (DoD) login banner."
  lineinfile: 
    state: '{{ item.st }}'
    regexp: '{{ item.rx }}'
    line: '{{ item.ln }}'
    dest: /etc/ssh/sshd_config
  with_items:
    - { ref: 'V-38611' , st: 'present', rx: "^(#)?IgnoreRhosts", ln: "IgnoreRhosts yes" }
    - { ref: 'V-38612' , st: 'present', rx: "^(#)?HostbasedAuthentication", ln: "HostbasedAuthentication no" }
#    - { ref: 'V-38613' , st: 'present', rx: "^(#)?PermitRootLogin", ln: "PermitRootLogin no" }
    - { ref: 'V-38615' , st: 'present', rx: "^(#)?Banner", ln: "Banner /etc/issue" }
    - { ref: 'V-38615' , st: 'present', rx: "^(#)?PrintLastLog", ln: "PrintLastLog yes" }
  notify: restart ssh
  when: cat2_sshd_config_audit|failed
  tags: 
    - cat2
    - medium
    - V-38611
    - V-38612
    - V-38613
    - V-38615
    - patch
    - ssh


# Postfix should be used instead.
- name: "MEDIUM | V-38671 | AUDIT | The sendmail package must be removed."
  command: rpm -q sendmail postfix
  ignore_errors: yes
  changed_when: no
  register: sendmail_install_audit
  failed_when: "'package sendmail is not installed' not in sendmail_install_audit.stdout
             or 'package postfix is not installed' in sendmail_install_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38671
    - sendmail
    - postfix
    - packages

- name: "MEDIUM | V-38671 | PATCH | The sendmail package must be removed."
  yum:
      name: '{{ item.name }}'
      state: '{{ item.state }}'
  with_items:
      - { ref: 'V-38671' , name: sendmail , state: absent }
      - { ref: 'V-38671' , name: postfix , state: present }
  when: sendmail_install_audit.failed
  tags:
      - medium
      - cat2
      - V-38671
      - sendmail
      - postfix
      - packages
      - patch

- name: "MEDIUM | V-38674 | AUDIT |  X Windows must not be enabled unless required"
  command: systemctl get-default
  ignore_errors: yes
  changed_when: no
  register: graphical_target_audit
  failed_when:
      - not cent7stig_xwindows_required
      - "'multi-user.target' not in graphical_target_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38674
    - xwindows
    - gui

- name: "MEDIUM | V-38674 | PATCH |  X Windows must not be enabled unless required"
  command: systemctl set-default multi-user.target
  when: 
      - not cent7stig_xwindows_required
      - graphical_target_audit.failed
  tags:
      - medium
      - cat2
      - V-38674
      - xwindows
      - gui
      - patch

## V-38630: Not implemented yet
#- name: "MEDIUM | V-38630 | AUDIT | The graphical desktop environment must automatically lock after 15 minutes of inactivity and the system must require user to re-authenticate to unlock the environment"
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38630' , 'xwindows' , 'gui' , 'screen_lock' ]
#
#- name: "MEDIUM | V-38630 | PATCH | The graphical desktop environment must automatically lock after 15 minutes of inactivity and the system must require user to re-authenticate to unlock the environment"
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38630' , 'xwindows' , 'gui' , 'screen_lock' ]

## V-38688: Not implemented yet
#- name: "MEDIUM | V-38688 | AUDIT | A login banner must be displayed immediately prior to, or as part of, graphical desktop environment login prompts."
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38688' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]
#
#- name: "MEDIUM | V-38688 | PATCH | A login banner must be displayed immediately prior to, or as part of, graphical desktop environment login prompts."
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38688' , 'logon_settings' , 'xwindows' , 'gui' , 'dod_logon_banner' ]

#- name: "MEDIUM | V-38629 | AUDIT | The graphical desktop environment must set the idle timeout to no more than 15 minutes"
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38629' , 'xwindows' , 'gui' , 'screen_lock' ]

#- name: "MEDIUM | V-38629 | PATCH | The graphical desktop environment must set the idle timeout to no more than 15 minutes"
#  command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type int --set /apps/gnome-screensaver/idle_delay 15
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38629' , 'xwindows' , 'gui' , 'screen_lock' ]

#- name: "MEDIUM | V-38638 | AUDIT | The graphical desktop environment must have automatic lock enabled"
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38638' , 'xwindows' , 'gui' , 'screen_lock' ]

#- name: "MEDIUM | V-38638 | PATCH | The graphical desktop environment must have automatic lock enabled"
#  command: gconftool-2 --direct --config-source xml:readwrite:/etc/gconf/gconf.xml.mandatory --type bool --set /apps/gnome-screensaver/lock_enabled true
#  when: cent7stig_xwindows_required
#  tags: [ 'medium' , 'cat2' , 'V-38638' , 'xwindows' , 'gui' , 'screen_lock' ]


- name: "MEDIUM | V-38679 | AUDIT | The DHCP client must be disabled if not needed."
  command: grep -L "^BOOTPROTO=none" /etc/sysconfig/network-scripts/ifcfg-* | grep -v $(date +%Y) | grep -v ifcfg-lo
  ignore_errors: yes
  changed_when: no
  register: interface_config_files_audit
  failed_when: interface_config_files_audit.stdout_lines|length > 0
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38679
    - network
    - dhcp

- name: "MEDIUM | V-38679 | PATCH | The DHCP client must be disabled if not needed"
  lineinfile:
    regexp: '^(#)?BOOTPROTO='
    line: 'BOOTPROTO=none'
    dest: "{{ item }}"
    backup: no
  with_items: '{{ interface_config_files_audit.stdout_lines }}'
  when: 
    - interface_config_files_audit.failed
    - not cent7stig_use_dhcp
  tags:
      - medium
      - cat2
      - V-38679
      - network
      - dhcp
      - patch

- name: "MEDIUM | V-38633 | AUDIT | The system must set a maximum audit log file size.\n
     \t\tMEDIUM | V-38636 | AUDIT | The system must retain enough rotated audit logs to cover the required log retention period.\n
     \t\tMEDIUM | V-38680 | AUDIT | The audit system must identify staff members to receive notifications of audit log storage volume capacity issues.\n
     \t\tMEDIUM | V-54381 | AUDIT | The audit system must switch the system to single-user mode when available audit storage volume becomes dangerously low."

  command: grep "^{{ item.ln }}" /etc/audit/auditd.conf
  ignore_errors: yes
  changed_when: no
  register: cat2_auditd_config_audit
  with_items:
    - { ref: 'V-38633', st: 'present', rx: '^(#)?max_log_file\s=', ln: "max_log_file = {{ cent7stig_auditd_config['max_log_file'] }}" }
    - { ref: 'V-38636', st: 'present', rx: '^(#)?num_logs\s=', ln: "num_logs = {{ cent7stig_auditd_config['num_logs'] }}" }
    - { ref: 'V-38680', st: 'present', rx: '^(#)?action_mail_acct\s=', ln: "action_mail_acct = {{ cent7stig_auditd_config['action_mail_acct'] }}" }
    - { ref: 'V-54381', st: 'present', rx: '^(#)?admin_space_left_action\s=', ln: "admin_space_left_action = {{ cent7stig_auditd_config['admin_space_left_action'] }}" }
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38633
    - V-38636
    - V-38680
    - V-54381
    - network
    - auditd

- name: "MEDIUM | V-38633 | AUDIT | The system must set a maximum audit log file size.\n
     \t\tMEDIUM | V-38636 | PATCH | The system must retain enough rotated audit logs to cover the required log retention period.\n
     \t\tMEDIUM | V-38680 | PATCH | The audit system must identify staff members to receive notifications of audit log storage volume capacity issues.\n
     \t\tMEDIUM | V-54381 | PATCH | The audit system must switch the system to single-user mode when available audit storage volume becomes dangerously low."
  lineinfile:
    state: '{{ item.st }}'
    regexp: '{{ item.rx }}'
    line: '{{ item.ln }}'
    dest: /etc/audit/auditd.conf
  with_items:
    - { ref: 'V-38633', st: 'present', rx: '^(#)?max_log_file\s=', ln: "max_log_file = {{ cent7stig_auditd_config['max_log_file'] }}" }
    - { ref: 'V-38636', st: 'present', rx: '^(#)?num_logs\s=', ln: "num_logs = {{ cent7stig_auditd_config['num_logs'] }}" }
    - { ref: 'V-38680', st: 'present', rx: '^(#)?action_mail_acct\s=', ln: "action_mail_acct = {{ cent7stig_auditd_config['action_mail_acct'] }}" }
    - { ref: 'V-54381', st: 'present', rx: '^(#)?admin_space_left_action\s=', ln: "admin_space_left_action = {{ cent7stig_auditd_config['admin_space_left_action'] }}" }
  notify:
    - start auditd
    - reload auditd
  when: cat2_auditd_config_audit|failed
  tags:
      - medium
      - cat2
      - V-38633
      - V-38636
      - V-38680
      - V-54381
      - network
      - auditd
      - audit

# modinfo bluetooth indicates bluetooth as alias for net-pf-31
- name: "MEDIUM | V-38691 | AUDIT | The Bluetooth service must be disabled"
  shell: find /etc/modprobe{.conf,.d/*} -exec grep -ls '^install bluetooth /bin/false' {} \; ;find /etc/modprobe{.conf,.d/*} -exec grep -ls '^install net-pf-31 /bin/false' {} \;
  ignore_errors: yes
  changed_when: no
  register: bluetooth_reqs_audit
  failed_when: "{{ bluetooth_reqs_audit.stdout_lines|length }} < 1"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38691
    - bluetooth
    - kernel_modules

- name: "MEDIUM | V-38691 | PATCH | The Bluetooth service must be disabled"
  lineinfile:
      state: present
      create: yes
      line: install bluetooth /bin/false
      dest: /etc/modprobe.d/disable-bluetooth.conf
      owner: root
      group: root
      mode: "0644"
  when: bluetooth_reqs_audit.failed
  tags:
      - medium
      - cat2
      - V-38691
      - bluetooth
      - kernel_modules
      - patch

- name: "MEDIUM | V-38620 | AUDIT | The system clock must be synchronized continuously, or at least daily.\n
     \t\tMEDIUM | V-38621 | AUDIT | The system clock must be synchronized to an authoritative DoD time source."
  command: rpm -q ntp
  ignore_errors: yes
  changed_when: no
  register: ntpd_install_audit
  failed_when: "'is not installed' in ntpd_install_audit.stdout"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38620
    - V-38621
    - ntp

- name: "MEDIUM | V-38620 | PATCH | The system clock must be synchronized continuously, or at least daily.\n
     \t\tMEDIUM | V-38621 | PATCH | The system clock must be synchronized to an authoritative DoD time source."
  yum:
    name: ntp
    state: present
  when:
      - cent7stig_install_packages
      - ntpd_install_audit.failed
  tags:
      - medium
      - cat2
      - V-38620
      - V-38621
      - ntp
      - patch

- name: "MEDIUM | V-38620 | AUDIT | The system clock must be synchronized continuously, or at least daily.\n
     \t\tMEDIUM | V-38621 | AUDIT | The system clock must be synchronized to an authoritative DoD time source."
  command: ntpq -p
  ignore_errors: yes
  changed_when: no
  register: ntpd_service_audit
  failed_when: "'No association ID' in ntpd_service_audit.stdout
             or 'Connection refused' in ntpd_service_audit.stderr"
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38620
    - V-38621
    - ntp

- name: "MEDIUM | V-38620 | PATCH | The system clock must be synchronized continuously, or at least daily.\n
     \t\tMEDIUM | V-38621 | PATCH | The system clock must be synchronized to an authoritative DoD time source."
  template: src=ntp.conf.j2 dest=/etc/ntp.conf backup=yes owner=root group=root mode=0644
  when: "'No association ID' in ntpd_service_audit.stdout"
  notify: restart ntpd
  tags:
      - medium
      - cat2
      - V-38620
      - V-38621
      - ntp
      - patch

- name: "MEDIUM | V-38620 | PATCH | The system clock must be synchronized continuously, or at least daily.\n
     \t\tMEDIUM | V-38621 | PATCH | The system clock must be synchronized to an authoritative DoD time source."
  service:
    name: ntpd.service
    state: started
    enabled: yes
  when: "'Connection refused' in ntpd_service_audit.stderr"
  tags:
      - medium
      - cat2
      - V-38620
      - V-38621
      - ntp
      - patch

- name: "MEDIUM | V-38622 | AUDIT | Mail relaying must be restricted"
  command: grep -i "^inet_interfaces = localhost" /etc/postfix/main.cf 
  ignore_errors: yes
  changed_when: no
  register: is_mail_relay_audit
  failed_when: is_mail_relay_audit.stdout_lines|length < 1
  when: not cent7stig_is_mail_relay
  tags:
    - medium
    - cat2
    - audit
    - always
    - V-38622
    - postfix

- name: "MEDIUM | V-38622 | PATCH | Mail relaying must be restricted"
  lineinfile: 
    regexp: '^(#)?inet_interfaces'
    line: 'inet_interfaces = localhost'
    dest: /etc/postfix/main.cf 
  when: 
     - not cent7stig_is_mail_relay
     - is_mail_relay_audit.failed
  notify: restart postfix
  tags:
     - cat2
     - medium
     - V-38622
     - postfix
     - patch

# SELinux not installed by default :(, need reboot to enable :((
#- name: "MEDIUM | V-51363 | AUDIT | The system must use a Linux Security Module configured to enforce limits on system services."
#  command: selinuxenabled
#  register: selinux_adit
#
#- name: "MEDIUM | V-51363 | PATCH | The system must use a Linux Security Module configured to enforce limits on system services."
#  yum:
#    name:
#      - libselinux-utils
#      - libselinux
#      - selinux-policy-targeted
#      - selinux-policy
#      - libselinux-python
#    state: present
#  tags: [ 'cat2' , 'V-51363' , 'selinux' ]
#
#- name: "MEDIUM | V-51363 | PATCH | The system must use a Linux Security Module configured to enforce limits on system services."
#  selinux:
#    conf: /etc/selinux/config
#    policy: "{{ cent7stig_selinux_pol }}"
#    state: enforcing
#  tags: [ 'cat2' , 'V-51363' , 'selinux' ]
